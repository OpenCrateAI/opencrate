# Optimized single-stage build with aggressive cleanup
FROM opencrate-base-cuda:v0.1.0
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Kolkata
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
# Install Python and dependencies in one optimized layer
RUN add-apt-repository ppa:deadsnakes/ppa -y &&\
    apt update -y &&\
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal &&\
    apt install -y --no-install-recommends python3.7-distutils python3.7-dev &&\
    curl -sS https://bootstrap.pypa.io/pip/3.7/get-pip.py | python3.7 &&\
    python3.7 -m pip install --upgrade pip --root-user-action=ignore --no-cache-dir &&\
    export PATH="$HOME/.cargo/bin:$PATH" &&\
    mkdir -p /usr/local/cargo /usr/local/rustup &&\
    cp -r $HOME/.cargo/* /usr/local/cargo/ 2>/dev/null || true &&\
    cp -r $HOME/.rustup/* /usr/local/rustup/ 2>/dev/null || true &&\
    ln -sf /usr/local/cargo/bin/* /usr/local/bin/ 2>/dev/null || true &&\
    apt-get autoremove -y &&\
    apt-get clean &&\
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.cache ~/.cargo ~/.rustup
ENV PATH='/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/cargo/bin:${PATH}'
# Install Python packages
RUN python3.7 -m pip install --no-cache-dir --upgrade --root-user-action=ignore ipython jupyter &&\
    python3.7 -m pip cache purge
# Install application
RUN mkdir -p /home/opencrate/
WORKDIR /home/opencrate/
COPY src/ /home/opencrate/src
COPY pyproject.toml /home/opencrate/
COPY setup.cfg /home/opencrate/
COPY setup.py /home/opencrate/
RUN python3.7 -m pip install -e . --no-cache-dir --root-user-action=ignore && \
    python3.7 -m pip cache purge && \
    # Final aggressive cleanup
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.cache
RUN mkdir /root/.hooks/
COPY .docker/hooks/ /root/.hooks/
WORKDIR /home/workspace/
RUN git config --global --add safe.directory '*' && git config --global init.defaultBranch main