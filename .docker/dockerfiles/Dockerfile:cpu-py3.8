
FROM ubuntu:22.04

# Environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Kolkata

RUN apt update -y &&\
    apt upgrade -y &&\
    apt install -y software-properties-common ca-certificates tzdata gcc wget curl vim git &&\
    apt clean && rm -rf /var/lib/apt/lists/* &&\
    echo $TZ > /etc/timezone && dpkg-reconfigure -f noninteractive tzdata

RUN apt update -y &&\
    apt install -y fontconfig btop unrar nano make tree htop bat tldr zoxide cpufetch jq p7zip-full p7zip-rar

RUN add-apt-repository ppa:zhangsongcui3371/fastfetch -y &&\
    apt install -y fastfetch

RUN mkdir -p /etc/apt/keyrings &&\
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | gpg --dearmor -o /etc/apt/keyrings/gierens.gpg &&\
    echo 'deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main' | tee /etc/apt/sources.list.d/gierens.list &&\
    chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list &&\
    apt update -y &&\
    apt install -y eza

COPY .docker/cli/ /home/
COPY .docker/fonts/ /home/
RUN apt install -y zsh &&\
    chsh -s $(which zsh) &&\
    wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O - | zsh || true &&\
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k &&\
    git clone https://github.com/zsh-users/zsh-autosuggestions ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autosuggestions &&\
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting &&\
    git clone https://github.com/marlonrichert/zsh-autocomplete.git ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-autocomplete &&\
    curl --proto '=https' --tlsv1.2 -LsSf https://setup.atuin.sh | sh &&\
    mv /home/zsh/.zshrc ~/.zshrc && mv /home/zsh/.p10k.zsh ~/.p10k.zsh && mv /home/zsh/.aliases.sh ~/ && mv /home/zsh/.exports.sh ~/ &&\
    mkdir -p ~/.config/btop/ && mkdir -p ~/.config/atuin/ && mkdir -p ~/.config/fastfetch/ &&\
    cp -r /home/btop/ ~/.config/ &&\
    cp -r /home/atuin/ ~/.config/ &&\
    cp -r /home/fastfetch/ ~/.config/ &&\
    rm -rf /home/zsh/ &&\
    mkdir -p ~/.local/share/fonts &&\
    cp /home/*ttf ~/.local/share/fonts/ &&\
    fc-cache -f -v &&\
    rm /home/*ttf

# Init scripts
COPY ./.docker/hooks/ /root/

RUN add-apt-repository ppa:deadsnakes/ppa -y &&\
    apt install -y python3.8-distutils python3.8-dev python3.8-venv &&\
    curl -sS https://bootstrap.pypa.io/get-pip.py | python3.8 &&\
    python3.8 -m pip install --upgrade pip
RUN python3.8 -m pip install --no-cache-dir --upgrade --root-user-action=ignore matplotlib seaborn scikit-learn scikit-image skl2onnx pandas ipython scipy opencv-python pillow jupyter onnx openvino rich requests safetensors albumentations loguru nvitop onnxruntime &&\
    python3.8 -m pip cache purge

# Install opencrate
RUN mkdir /home/opencrate/
WORKDIR /home/opencrate/
COPY src/ /home/opencrate/src
COPY pyproject.toml /home/opencrate/
COPY setup.cfg /home/opencrate/
COPY setup.py /home/opencrate/
RUN python3.8 -m pip install -e . --no-cache-dir --root-user-action=ignore

# Setup workspace and project
WORKDIR /home/workspace/
RUN git config --global --add safe.directory '*' && git config --global init.defaultBranch main
