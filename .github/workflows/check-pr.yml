name: Check PR

on:
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "tests/**"
      - "docker/**"
      - "pyproject.toml"
      - "setup.cfg"
      - "setup.py"
      - "Makefile"
      - "Makefile.ci"
      - "VERSION"
      - "PYTHON_VERSIONS"
      - ".github/workflows/check-pr.yml"

# 1. Concurrency: Cancel in-progress runs for the same PR
concurrency:
  group: pr-${{ github.ref }}
  cancel-in-progress: true

# 2. Permissions: Least privilege (Read-only by default)
permissions:
  contents: read

jobs:
  static-checks:
    name: Static Checks
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Packages
        run: |
          python3.10 -m pip install --upgrade pip --root-user-action=ignore
          python3.10 -m pip install ruff mypy types-requests types-PyYAML types-docker --root-user-action=ignore
          python3.10 -m pip install ".[ci]" --root-user-action=ignore --extra-index-url https://download.pytorch.org/whl/cpu

      - name: Running tests
        run: make test

  generate-python-edges:
    name: Generate Matrix
    runs-on: blacksmith-2vcpu-ubuntu-2404
    outputs:
      python_versions: ${{ steps.set-matrix.outputs.python_versions }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          VERSIONS=$(python3 -c 'import json; lines=[l.strip() for l in open("PYTHON_VERSIONS") if l.strip()]; print(json.dumps([lines[0], lines[-1]]))')
          echo "python_versions=$VERSIONS" >> $GITHUB_OUTPUT

  build-and-test:
    name: Build & Test Docker Image Python ${{ matrix.python_version }}
    runs-on: blacksmith-2vcpu-ubuntu-2404
    needs: [static-checks, generate-python-edges]
    strategy:
      fail-fast: false
      matrix:
        python_version: ${{ fromJson(needs.generate-python-edges.outputs.python_versions) }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install Python dependencies
        run: pip install rich loguru
      - name: Build Image
        run: |
          make docker-generate PYTHON_VERSIONS="${{ matrix.python_version }}" RUNTIMES="cpu"
          make ci-build MODE=test RUNTIME=cpu PYTHON_VERSION=${{ matrix.python_version }} VERSION=$(cat VERSION) REBUILD_FLAG=true CACHE_UPDATE=false
      - name: Test Image
        run: make docker-test DEPS=ci RUNTIME=cpu PYTHON_VERSION=${{ matrix.python_version }} VERSION=$(cat VERSION)
