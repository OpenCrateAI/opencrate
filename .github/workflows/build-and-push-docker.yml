name: Build, Scan, and Push OpenCrate Docker Images

# This workflow runs on pushes to tags like "v1.0.0", "v1.2.3", etc.
# It can also be triggered manually from the GitHub Actions UI.
on:
    push:
        tags:
            - 'v*.*.*'
    workflow_dispatch:

# Define environment variables for the entire job
env:
    # The name of the Docker Hub image used for build caching
    CACHE_IMAGE: braindotai/opencrate-build-cache:latest

jobs:
    build-scan-and-push:
        name: Build, Scan and Push to Docker Hub
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Get the version from the Git tag
              # This extracts the tag name (e.g., "v1.2.3") and sets it as an output.
              id: get_version
              run: echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.10'

            - name: Install Python dependencies
              run: pip install rich loguru

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Generate Dockerfiles and Build Images with Cache
              run: |
                  make build-opencrate-all \
                      VERSION=${{ steps.get_version.outputs.VERSION }} \
                      DOCKER_BUILD_ARGS="--cache-from type=registry,ref=${{ env.CACHE_IMAGE }} --cache-to type=registry,ref=${{ env.CACHE_IMAGE }},mode=max,compression=zstd"

            - name: Install Trivy for vulnerability scanning
              run: |
                  sudo apt-get install wget apt-transport-https gnupg lsb-release -y
                  wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
                  echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
                  sudo apt-get update
                  sudo apt-get install trivy -y

            - name: Scan All Built Images
              run: |
                  SUPPORTED_PYTHONS="3.7 3.8 3.9 3.10 3.11 3.12"
                  VERSION=${{ steps.get_version.outputs.VERSION }}
                  echo "Scanning all images for version ${VERSION}..."

                  for python_version in $SUPPORTED_PYTHONS; do
                      for runtime in cpu cuda; do
                          IMAGE_NAME="braindotai/opencrate-${runtime}-py${python_version}:${VERSION}"
                          echo "---"
                          echo "Scanning image: ${IMAGE_NAME}"
                          trivy image --exit-code 1 --severity CRITICAL,HIGH --ignore-unfixed ${IMAGE_NAME}
                      done
                  done
                  echo "---"
                  echo "All images scanned successfully. No high or critical vulnerabilities found."

            - name: Push all Docker images
              # This step only runs if the scan step above succeeds
              # The 'latest=True' argument tells the Makefile to also tag and push the 'latest' tag
              run: |
                  make push-opencrate-all \
                      latest=True \
                      VERSION=${{ steps.get_version.outputs.VERSION }}