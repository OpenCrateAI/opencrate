name: Build, Scan, and Push OpenCrate Docker Images

on:
    push:
        tags:
            - 'v*.*.*'
    workflow_dispatch:

env:
    CACHE_IMAGE: braindotai/opencrate-build-cache:latest

jobs:
    build-scan-and-push:
        name: Build, Scan and Push to Docker Hub
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Get the version from the Git tag
              id: get_version
              run: echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.10'

            - name: Install Python dependencies
              run: pip install rich loguru

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Generate Dockerfiles and Build Images with Cache
              run: |
                  make build-opencrate-all \
                      VERSION=${{ steps.get_version.outputs.VERSION }} \
                      DOCKER_BUILD_ARGS="--cache-from type=registry,ref=${{ env.CACHE_IMAGE }},ignore-error=true --cache-to type=registry,ref=${{ env.CACHE_IMAGE }},mode=max"

            - name: Push all Docker images
              run: |
                  make push-opencrate-all \
                      latest=True \
                      VERSION=${{ steps.get_version.outputs.VERSION }}